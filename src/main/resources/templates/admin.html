<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard â€“ User Management</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Admin Dashboard</a>
      <form class="d-flex">
        <a class="btn btn-outline-light" href="/logout">Logout</a>
      </form>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Users Table -->
    <h2>All Users</h2>
    <table class="table table-hover shadow-sm">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Email</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersTableBody">
        <!-- Populated by JS -->
      </tbody>
    </table>

    <!-- Create Form -->
    <hr/>
    <h3>Create New User</h3>
    <form id="createForm" class="row g-3">
      <div class="col-md-3">
        <input
          type="text"
          id="newUsername"
          class="form-control"
          placeholder="Username"
          required
        />
      </div>
      <div class="col-md-3">
        <input
          type="email"
          id="newEmail"
          class="form-control"
          placeholder="Email"
          required
        />
      </div>
      <div class="col-md-3">
        <input
          type="password"
          id="newPassword"
          class="form-control"
          placeholder="Password"
          required
        />
      </div>
      <div class="col-md-2">
        <select id="newRole" class="form-select">
          <option value="USER">USER</option>
          <option value="ADMIN">ADMIN</option>
        </select>
      </div>
      <div class="col-md-1 d-grid">
        <button type="submit" class="btn btn-success">Create</button>
      </div>
    </form>
  </div>

  <!-- Bootstrap & Fetch Script -->
  <script>
    const API = '';
    async function authFetch(path, opts = {}) {
      opts.credentials = 'include';
      opts.headers = { 'Content-Type': 'application/json' };
      const res = await fetch(API + path, opts);
      if (!res.ok) throw new Error(res.status);
      return opts.method === 'GET' ? res.json() : res.json().catch(() => {});
    }

    // Load users into table
    async function loadUsers() {
      try {
        const users = await authFetch('/users', { method: 'GET' });
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';
        users.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.id}</td>
            <td><input class="form-control form-control-sm" value="${u.username}" data-id="${u.id}" /></td>
            <td><input class="form-control form-control-sm" value="${u.email}" data-id="${u.id}" /></td>
            <td>
              <select class="form-select form-select-sm" data-id="${u.id}">
                <option value="USER" ${u.role==='USER'? 'selected':''}>USER</option>
                <option value="ADMIN" ${u.role==='ADMIN'? 'selected':''}>ADMIN</option>
              </select>
            </td>
            <td>
              <button class="btn btn-sm btn-primary save-btn" data-id="${u.id}">Save</button>
              <button class="btn btn-sm btn-danger delete-btn" data-id="${u.id}">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        attachHandlers();
      } catch (e) {
        alert('Error loading users: ' + e);
      }
    }

    function attachHandlers() {
      document.querySelectorAll('.save-btn').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          const username = document.querySelector(`input[data-id="${id}"]`).value;
          const email = document.querySelector(`tr [data-id="${id}"]`)[1].value;
          const role = document.querySelector(`select[data-id="${id}"]`).value;
          await authFetch(`/users/${id}`, {
            method: 'PUT',
            body: JSON.stringify({ username, email, role })
          });
          loadUsers();
        };
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('Delete this user?')) return;
          await authFetch(`/users/${btn.dataset.id}`, { method: 'DELETE' });
          loadUsers();
        };
      });
    }

    // Create form
    document.getElementById('createForm').onsubmit = async e => {
      e.preventDefault();
      await authFetch('/users', {
        method: 'POST',
        body: JSON.stringify({
          username: document.getElementById('newUsername').value,
          email: document.getElementById('newEmail').value,
          password: document.getElementById('newPassword').value,
          role: document.getElementById('newRole').value
        })
      });
      e.target.reset();
      loadUsers();
    };

    loadUsers();
  </script>
</body>
</html>
